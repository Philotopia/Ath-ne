<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ath√®nes ‚Äî Guide</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { stone: { 850: '#1c1917', 900: '#0c0a09' } } } }
    }
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap');
    body { font-family: 'Lato', sans-serif; transition: background-color .25s, color .25s; }
    h1, h2, h3, .serif-title { font-family: 'Cinzel', serif; }
    #map-container { height: 520px; width: 100%; border-radius: .75rem; }

    @keyframes fadeIn { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform: translateY(0)} }
    .animate-fade-in { animation: fadeIn .24s ease both; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    .dark ::-webkit-scrollbar-track { background: #2d2d2d; }
    .dark ::-webkit-scrollbar-thumb { background: #555; }

    .img-skeleton {
      background: linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.12), rgba(0,0,0,0.06));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite;
    }
    .dark .img-skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.12), rgba(255,255,255,0.06));
    }
    @keyframes shimmer { 0% { background-position: 200% 0 } 100% { background-position: -200% 0 } }
  </style>
</head>

<body class="bg-[#f4f1ea] text-[#2c2c2c] dark:bg-stone-900 dark:text-stone-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    function useLocalStorageState(key, initialValue) {
      const [value, setValue] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; }
        catch { return initialValue; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(value)); } catch {} }, [key, value]);
      return [value, setValue];
    }

    // --- LIEUX (avec titres Wikipedia) ---
    const placesData = [
      { id: 1,  name: "Acropole d'Ath√®nes", zone: "Acropole", color: "red", address: "Athens 105 58", coords: [37.9715, 23.7257],
        hours: "08:00 - 17:00", price: "Hiver: 10‚Ç¨ | Pass 30‚Ç¨", booking: "Obligatoire", myth: "Duel Ath√©na/Pos√©idon.", philo: "Hybris et Mesure.",
        website: "http://odysseus.culture.gr/h/3/eh351.jsp?obj_id=2384", type: "Primaire",
        wikiTitle: "Acropole_d'Ath√®nes",
        activity: "Monter les Propyl√©es, faire le tour du Parth√©non, voir l'√ârechth√©ion, vue panoramique."
      },
      { id: 2,  name: "Mus√©e de l'Acropole", zone: "Acropole", color: "red", address: "Dionysiou Areopagitou 15", coords: [37.9684, 23.7285],
        hours: "Lun-Jeu: 9h-17h | Ven: 22h", price: "Hiver: 5‚Ç¨", booking: "Conseill√©e", myth: "Caryatides.", philo: "M√©moire.",
        website: "https://www.theacropolismuseum.gr/en", type: "Primaire",
        wikiTitle: "Mus√©e_de_l'Acropole",
        activity: "Voir les Caryatides, sols de verre, resto avec vue."
      },
      { id: 3,  name: "Colline de la Pnyx", zone: "Acropole", color: "red", address: "Pnyx", coords: [37.9716, 23.7194],
        hours: "24h/24", price: "Gratuit", booking: "Non", myth: "Zeus Hypsistos.", philo: "D√©mocratie.",
        website: "https://fr.wikipedia.org/wiki/Pnyx", type: "Primaire",
        wikiTitle: "Pnyx",
        activity: "Tribune des orateurs, vue top sur l'Acropole."
      },
      { id: 12, name: "Monument de Philopappos", zone: "Acropole", color: "red", address: "Filopappou Hill", coords: [37.9673, 23.7213],
        hours: "24h/24", price: "Gratuit", booking: "Non", myth: "Muses.", philo: "Vue panoramique.",
        website: "https://fr.wikipedia.org/wiki/Monument_de_Philopappos", type: "Secondaire",
        wikiTitle: "Monument_de_Philopappos",
        activity: "Balade facile et coucher de soleil."
      },
      { id: 13, name: "Od√©on d'H√©rode Atticus", zone: "Acropole", color: "red", address: "Dionysiou Areopagitou", coords: [37.9708, 23.7246],
        hours: "Visible de l'ext√©rieur", price: "-", booking: "Spectacles uniquement", myth: "Dionysos.", philo: "Musique & Trag√©die.",
        website: "https://fr.wikipedia.org/wiki/Od√©on_d'H√©rode_Atticus", type: "Secondaire",
        wikiTitle: "Od√©on_d'H√©rode_Atticus",
        activity: "Admirer depuis le chemin pi√©tonnier."
      },

      { id: 4,  name: "Agora Antique", zone: "Agora", color: "blue", address: "Adrianou 24", coords: [37.9750, 23.7225],
        hours: "08:00 - 17:00", price: "Hiver: 5‚Ç¨ | Pass 30‚Ç¨", booking: "Non", myth: "H√©pha√Østos.", philo: "Socrate.",
        website: "https://fr.wikipedia.org/wiki/Agora_d'Ath√®nes", type: "Primaire",
        wikiTitle: "Agora_d'Ath√®nes",
        activity: "Temple d'H√©pha√Østos, Stoa d'Attale, traces de la vie civique."
      },
      { id: 5,  name: "Biblioth√®que d'Hadrien", zone: "Agora", color: "blue", address: "Areos 3", coords: [37.9756, 23.7262],
        hours: "08:00 - 17:00", price: "Hiver: 3‚Ç¨ | Pass 30‚Ç¨", booking: "Non", myth: "Romain.", philo: "Savoir.",
        website: "https://fr.wikipedia.org/wiki/Biblioth√®que_d'Hadrien", type: "Primaire",
        wikiTitle: "Biblioth√®que_d'Hadrien",
        activity: "Vestiges romains et couches byzantines."
      },
      { id: 6,  name: "Kerameikos", zone: "Agora", color: "blue", address: "Ermou 148", coords: [37.9783, 23.7179],
        hours: "08:00 - 17:00", price: "Hiver: 4‚Ç¨ | Pass 30‚Ç¨", booking: "Non", myth: "Enfers.", philo: "Mort.",
        website: "https://fr.wikipedia.org/wiki/K√©ramique_(Ath√®nes)", type: "Primaire",
        wikiTitle: "K√©ramique_(Ath√®nes)",
        activity: "All√©e des tombes + petit mus√©e."
      },
      { id: 14, name: "Temple de Zeus (Olympieion)", zone: "Agora", color: "blue", address: "Athens 105 57", coords: [37.9693, 23.7331],
        hours: "08:00 - 17:00", price: "Hiver: 3‚Ç¨ | Pass 30‚Ç¨", booking: "Non", myth: "Zeus.", philo: "Grandeur & D√©clin.",
        website: "https://fr.wikipedia.org/wiki/Temple_de_Zeus_Olympien", type: "Secondaire",
        wikiTitle: "Temple_de_Zeus_Olympien",
        activity: "Colonnes monumentales + Porte d'Hadrien."
      },
      { id: 15, name: "Jardin National", zone: "Agora", color: "blue", address: "Leoforos Amalias 1", coords: [37.9730, 23.7369],
        hours: "Lever au Coucher", price: "Gratuit", booking: "Non", myth: "Reine Amalia.", philo: "Botanique.",
        website: "https://fr.wikipedia.org/wiki/Jardin_national_d'Ath√®nes", type: "Secondaire",
        wikiTitle: "Jardin_national_d'Ath√®nes",
        activity: "Balade, tortues, pause lecture."
      },

      { id: 7,  name: "Lyc√©e d'Aristote", zone: "Philosophie", color: "purple", address: "Rigillis 11", coords: [37.9738, 23.7443],
        hours: "08:00 - 17:00", price: "Hiver: 2‚Ç¨ | Pass 30‚Ç¨", booking: "Non", myth: "Apollon.", philo: "Logique.",
        website: "https://fr.wikipedia.org/wiki/Lyc√©e_d'Aristote", type: "Primaire",
        wikiTitle: "Lyc√©e_d'Aristote",
        activity: "Lire un extrait sur place, ambiance calme."
      },
      { id: 9,  name: "Mus√©e Arch√©ologique", zone: "Philosophie", color: "purple", address: "28is Oktovriou 44", coords: [37.9891, 23.7326],
        hours: "08:30 - 15:30", price: "Hiver: 6‚Ç¨", booking: "Non", myth: "Myc√®nes.", philo: "Art.",
        website: "https://fr.wikipedia.org/wiki/Mus√©e_national_arch√©ologique_d'Ath√®nes", type: "Primaire",
        wikiTitle: "Mus√©e_national_arch√©ologique_d'Ath√®nes",
        activity: "Masque d'Agamemnon, Anticyth√®re, √©volution de la statuaire."
      },
      { id: 16, name: "Stade Panath√©na√Øque", zone: "Philosophie", color: "purple", address: "Leof. Vasileos Konstantinou", coords: [37.9686, 23.7408],
        hours: "08:00 - 17:00", price: "10‚Ç¨", booking: "Non", myth: "Ath√©na (Jeux).", philo: "Agon.",
        website: "https://fr.wikipedia.org/wiki/Stade_panath√©na√Øque", type: "Secondaire",
        wikiTitle: "Stade_panath√©na√Øque",
        activity: "Monter en haut des gradins, tunnel, photo."
      },
      { id: 17, name: "Mus√©e Benaki", zone: "Philosophie", color: "purple", address: "Koumpari 1", coords: [37.9760, 23.7403],
        hours: "10:00 - 18:00 (Ferm√© Mar)", price: "12‚Ç¨", booking: "Non", myth: "Histoire Grecque.", philo: "Identit√©.",
        website: "https://fr.wikipedia.org/wiki/Mus√©e_Benaki", type: "Secondaire",
        wikiTitle: "Mus√©e_Benaki",
        activity: "Histoire grecque + caf√© terrasse."
      },
      { id: 18, name: "Mus√©e Art Cycladique", zone: "Philosophie", color: "purple", address: "Neofitou Douka 4", coords: [37.9757, 23.7424],
        hours: "10:00 - 17:00 (Ferm√© Mar)", price: "12‚Ç¨", booking: "Non", myth: "Cyclades.", philo: "Abstraction.",
        website: "https://fr.wikipedia.org/wiki/Mus√©e_d%27art_cycladique", type: "Secondaire",
        wikiTitle: "Mus√©e_d%27art_cycladique",
        activity: "Idoles cycladiques + aile Stathatos."
      },

      { id: 10, name: "Cap Sounion", zone: "Hors Ville", color: "emerald", address: "Sounio 195 00", coords: [37.6502, 24.0245],
        hours: "09:30 - Coucher soleil", price: "Hiver: 5‚Ç¨", booking: "Non", myth: "√âg√©e.", philo: "Nature.",
        website: "https://fr.wikipedia.org/wiki/Cap_Sounion", type: "Primaire",
        wikiTitle: "Cap_Sounion",
        activity: "Coucher de soleil derri√®re les colonnes."
      },
      { id: 11, name: "Lac de Vouliagmeni", zone: "Hors Ville", color: "emerald", address: "Vouliagmeni 166 71", coords: [37.8073, 23.7854],
        hours: "08:00 - 17:00", price: "~16‚Ç¨", booking: "Non", myth: "Nymphes.", philo: "Soin.",
        website: "https://fr.wikipedia.org/wiki/Lac_de_Vouliagm√©ni", type: "Primaire",
        wikiTitle: "Lac_de_Vouliagm√©ni",
        activity: "Baignade thermale + caf√©."
      },
      { id: 19, name: "Centre Culturel SNFCC", zone: "Hors Ville", color: "emerald", address: "Leof. Syggrou 364", coords: [37.9402, 23.6923],
        hours: "06:00 - Minuit", price: "Gratuit", booking: "Pour l'Op√©ra", myth: "Moderne.", philo: "Espace Public.",
        website: "https://fr.wikipedia.org/wiki/Centre_culturel_de_la_fondation_St√°vros_Ni√°rchos", type: "Secondaire",
        wikiTitle: "Centre_culturel_de_la_fondation_St√°vros_Ni√°rchos",
        activity: "Lighthouse, canal, biblioth√®que."
      },
      { id: 20, name: "Mont Lycabette", zone: "Hors Ville", color: "emerald", address: "Aristippou 1 (Funiculaire)", coords: [37.9820, 23.7432],
        hours: "24h/24", price: "Funiculaire ~7.50‚Ç¨", booking: "Non", myth: "Rocher d'Ath√©na.", philo: "Hauteur.",
        website: "https://fr.wikipedia.org/wiki/Mont_Lycabette", type: "Secondaire",
        wikiTitle: "Mont_Lycabette",
        activity: "Vue panoramique au sommet."
      },
    ];

    const zoneOrder = ["Acropole", "Agora", "Philosophie", "Hors Ville"];
    const colorToTailwind = { red: "red", blue: "blue", purple: "purple", emerald: "emerald" };
    const zoneTitle = (z) => z === "Acropole" ? "Le Sacr√©" : z === "Agora" ? "La Cit√©" : z === "Philosophie" ? "La Sagesse" : "La Nature";

    const MapComponent = ({ places, darkMode }) => {
      useEffect(() => {
        const container = L.DomUtil.get('map-container');
        if (container != null) container._leaflet_id = null;

        const map = L.map('map-container').setView([37.974, 23.73], 13);
        const lightTiles = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
        const darkTiles  = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        L.tileLayer(darkMode ? darkTiles : lightTiles, { attribution: '&copy; OSM & CartoDB' }).addTo(map);

        places.forEach(place => {
          const color = place.color === 'red' ? '#dc2626'
                      : place.color === 'purple' ? '#7c3aed'
                      : place.color === 'emerald' ? '#10b981'
                      : '#3b82f6';
          const marker = L.circleMarker(place.coords, {
            color, fillColor: color, fillOpacity: 0.85,
            radius: place.type === 'Primaire' ? 10 : 6
          });
          marker.addTo(map).bindPopup(`<b>${place.name}</b><br/>${place.address}`);
        });

        return () => map.remove();
      }, [places, darkMode]);

      return <div id="map-container" className="shadow-xl border border-gray-200 dark:border-stone-700"></div>;
    };

    // --- Wikipedia thumbnails ---
    const WIKI_API = "https://fr.wikipedia.org/api/rest_v1/page/summary/";
    const wikiUrl = (title) => "https://fr.wikipedia.org/wiki/" + title;

    async function fetchWikiThumb(title) {
      const res = await fetch(WIKI_API + encodeURIComponent(title), { mode: "cors" });
      if (!res.ok) throw new Error("Wiki fetch failed");
      const data = await res.json();
      const thumb = data?.thumbnail?.source || "";
      return { thumb, page: data?.content_urls?.desktop?.page || wikiUrl(title) };
    }

    // --- PlaceCard ---
    const PlaceCard = ({ p, c, getMapsLink, wikiThumb }) => {
      const img = wikiThumb?.thumb || "";
      const wikiPage = wikiThumb?.page || wikiUrl(p.wikiTitle);
      return (
        <div className="bg-white dark:bg-stone-800 rounded-xl shadow-sm border border-gray-100 dark:border-stone-700 overflow-hidden flex flex-col">
          <div className="w-full h-48 overflow-hidden relative bg-gray-100 dark:bg-stone-900">
            {img ? (
              <img src={img} alt={p.name} className="w-full h-full object-cover" loading="lazy"/>
            ) : (
              <div className="w-full h-full img-skeleton"></div>
            )}
            <div className={"absolute bottom-0 left-0 w-full h-1 bg-" + c + "-500"}></div>
            <div className="absolute top-2 right-2">
              <a href={wikiPage} target="_blank" className="text-[11px] px-2 py-1 rounded bg-black/55 text-white hover:bg-black/70">
                Photo : Wikipedia
              </a>
            </div>
          </div>

          <div className="p-5 flex-grow flex flex-col">
            <div className="flex justify-between items-start gap-2 mb-2">
              <h4 className="font-bold text-slate-900 dark:text-slate-100 text-lg">{p.name}</h4>
              {p.type === 'Secondaire' && <span className="text-[10px] bg-gray-100 dark:bg-stone-700 text-gray-500 px-2 py-0.5 rounded">2nd</span>}
            </div>

            <div className="flex flex-wrap gap-3 mb-4 text-sm">
              <a href={getMapsLink(p)} target="_blank" className="text-blue-600 dark:text-blue-400 hover:underline">üìç {p.address}</a>
              <a href={p.website} target="_blank" className="text-gray-500 dark:text-gray-300 hover:underline">üåê Site</a>
            </div>

            <div className="bg-gray-50 dark:bg-stone-700 p-3 rounded-lg text-sm mb-4">
              <div className="font-semibold text-gray-800 dark:text-gray-200">üïí {p.hours}</div>
              <div className="text-gray-600 dark:text-gray-300">üéüÔ∏è {p.price}</div>
            </div>

            {p.activity && (
              <div className="mb-4">
                <span className="text-xs font-bold uppercase tracking-wide text-gray-500 dark:text-gray-300 mb-1 block">√Ä faire :</span>
                <p className="text-sm text-gray-700 dark:text-gray-200 italic">‚Äú{p.activity}‚Äù</p>
              </div>
            )}

            <div className="space-y-2 text-sm mt-auto border-t border-gray-100 dark:border-stone-700 pt-3">
              <div className={"text-amber-800 dark:text-amber-200 bg-amber-50 dark:bg-amber-900/30 p-2 rounded-lg"}>‚ö° <b>Mythe:</b> {p.myth}</div>
              <div className={"text-sky-800 dark:text-sky-200 bg-sky-50 dark:bg-sky-900/30 p-2 rounded-lg"}>üß† <b>Philo:</b> {p.philo}</div>
            </div>
          </div>
        </div>
      );
    };

    // --- Planning (Agenda par jour) ---
    const KIND = {
      flight:   { label:"Vol",      cls:"bg-blue-600" },
      train:    { label:"Train",    cls:"bg-teal-600" },
      transfer: { label:"Transfert",cls:"bg-purple-600" },
      hotel:    { label:"H√¥tel",    cls:"bg-amber-600" },
      visit:    { label:"Visite",   cls:"bg-rose-600" },
      walk:     { label:"Balade",   cls:"bg-emerald-600" },
      food:     { label:"Repas",    cls:"bg-stone-700" },
      daytrip:  { label:"Excursion",cls:"bg-indigo-600" },
      note:     { label:"Note",     cls:"bg-gray-600" },
      alt:      { label:"Option",   cls:"bg-gray-600" },
    };

    const Modal = ({ children, onClose }) => (
      <div className="fixed inset-0 bg-black/55 z-[1000] flex items-center justify-center p-4" onClick={(e)=>{ if(e.target === e.currentTarget) onClose(); }}>
        <div className="w-full max-w-2xl bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700 rounded-2xl overflow-hidden shadow-2xl">
          {children}
        </div>
      </div>
    );

    const PlanningTab = () => {
      const [filePlan, setFilePlan] = useState(null);
      const [override, setOverride] = useLocalStorageState("athens_plan_override_v2", null);
      const [activeDay, setActiveDay] = useState("");
      const [editing, setEditing] = useState(null); // {dayIndex,item}
      const [jsonEditor, setJsonEditor] = useState(false);
      const [draft, setDraft] = useState("");

      useEffect(() => {
        (async () => {
          const res = await fetch("./data/tripPlan.json", { cache: "no-store" });
          const data = await res.json();
          setFilePlan(data);
          const plan = override || data;
          setDraft(JSON.stringify(plan, null, 2));
          setActiveDay(plan.days?.[0]?.date || "");
        })().catch(()=>{});
      }, []);

      const plan = override || filePlan;
      if (!plan) return <div className="bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700 rounded-xl p-5">Chargement‚Ä¶</div>;

      const exportJson = (obj, name) => {
        const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        a.click();
        URL.revokeObjectURL(url);
      };

      const importJson = (file) => {
        if (!file) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const parsed = JSON.parse(String(r.result));
            setOverride(parsed);
            setDraft(JSON.stringify(parsed, null, 2));
            setActiveDay(parsed.days?.[0]?.date || "");
            alert("Planning import√© (surcharge locale).");
          } catch {
            alert("JSON invalide.");
          }
        };
        r.readAsText(file);
      };

      const reset = () => {
        setOverride(null);
        setDraft(JSON.stringify(filePlan, null, 2));
        setActiveDay(filePlan.days?.[0]?.date || "");
      };

      const dayIndex = plan.days.findIndex(d => d.date === activeDay);
      const day = plan.days[dayIndex] || plan.days[0];

      const sortItems = (items) => {
        const key = (it) => (it.start || "99:99");
        return [...items].sort((a,b)=> key(a).localeCompare(key(b)));
      };

      const updatePlan = (mutator) => {
        const next = structuredClone(plan);
        mutator(next);
        setOverride(next);
        setDraft(JSON.stringify(next, null, 2));
      };

      const addItem = () => {
        updatePlan(next => {
          const di = next.days.findIndex(d => d.date === activeDay);
          const newItem = { id: "i_" + Math.random().toString(16).slice(2), kind:"visit", start:"10:00", end:"11:00", title:"Nouvel √©l√©ment", details:"" };
          next.days[di].items.push(newItem);
        });
      };

      const moveItem = (idx, dir) => {
        updatePlan(next => {
          const di = next.days.findIndex(d => d.date === activeDay);
          const items = next.days[di].items;
          const j = idx + dir;
          if (j < 0 || j >= items.length) return;
          const tmp = items[idx];
          items[idx] = items[j];
          items[j] = tmp;
        });
      };

      const applyDraft = () => {
        try {
          const parsed = JSON.parse(draft);
          setOverride(parsed);
          setActiveDay(parsed.days?.[0]?.date || "");
          setJsonEditor(false);
        } catch (e) {
          alert("JSON invalide : " + (e.message || e));
        }
      };

      return (
        <div className="animate-fade-in space-y-4">
          <div className="bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700 rounded-xl overflow-hidden">
            <div className="p-5 flex flex-wrap items-center justify-between gap-3">
              <div>
                <div className="text-xl font-bold serif-title text-slate-900 dark:text-slate-100">üóìÔ∏è Planning (Agenda)</div>
                <div className="text-sm text-gray-500">{plan.meta.title}</div>
              </div>
              <div className="flex flex-wrap gap-2">
                <button onClick={addItem} className="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">+ Ajouter</button>
                <button onClick={()=>exportJson(plan, "tripPlan.json")} className="px-3 py-2 text-sm rounded-lg bg-slate-900 text-white hover:bg-slate-800">Exporter</button>
                <label className="px-3 py-2 text-sm rounded-lg bg-slate-900 text-white hover:bg-slate-800 cursor-pointer">
                  Importer
                  <input type="file" accept="application/json" className="hidden" onChange={(e)=>importJson(e.target.files?.[0])}/>
                </label>
                <button onClick={()=>setJsonEditor(true)} className="px-3 py-2 text-sm rounded-lg bg-gray-100 dark:bg-stone-700 hover:bg-gray-200 dark:hover:bg-stone-600">√âditer JSON</button>
                {override && <button onClick={reset} className="px-3 py-2 text-sm rounded-lg bg-red-600 text-white hover:bg-red-700">Reset</button>}
              </div>
            </div>

            <div className="px-5 pb-5">
              <div className="flex flex-wrap gap-2">
                {plan.days.map(d => (
                  <button
                    key={d.date}
                    onClick={()=>setActiveDay(d.date)}
                    className={"px-3 py-2 text-sm rounded-full border transition " + (activeDay===d.date
                      ? "bg-[#8c2f39] text-white border-[#8c2f39]"
                      : "bg-white dark:bg-stone-900 border-gray-200 dark:border-stone-700 hover:bg-gray-50 dark:hover:bg-stone-800")}
                  >
                    {d.label} ‚Ä¢ {d.date}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="grid lg:grid-cols-3 gap-4">
            <div className="lg:col-span-2 bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700 rounded-xl overflow-hidden">
              <div className="p-5 flex items-center justify-between">
                <div className="font-bold text-slate-900 dark:text-slate-100">{day.label} ‚Äî {day.date}</div>
                <div className="text-xs text-gray-500">Clique sur un item pour modifier</div>
              </div>

              <div className="px-5 pb-5 space-y-2">
                {sortItems(day.items).map((it, idx) => (
                  <button
                    key={it.id}
                    onClick={()=>setEditing({ idx, item: it })}
                    className="w-full text-left bg-gray-50 dark:bg-stone-900/40 border border-gray-200 dark:border-stone-700 rounded-xl p-4 hover:shadow-sm transition"
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <div className="flex items-center gap-2">
                          <span className={"text-[11px] px-2 py-1 rounded-full text-white " + (KIND[it.kind]?.cls || "bg-gray-600")}>
                            {KIND[it.kind]?.label || it.kind}
                          </span>
                          <span className="text-sm text-gray-600 dark:text-gray-300">
                            {(it.start ? it.start : "‚Äî")} {it.end ? "‚Üí " + it.end : ""}
                          </span>
                        </div>
                        <div className="font-bold text-slate-900 dark:text-slate-100 mt-1 truncate">{it.title}</div>
                        {it.details && <div className="text-sm text-gray-600 dark:text-gray-300 mt-1">{it.details}</div>}
                      </div>

                      <div className="flex gap-1 shrink-0">
                        <span className="px-2 py-1 text-xs rounded bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700"
                              onClick={(e)=>{ e.preventDefault(); e.stopPropagation(); moveItem(idx, -1); }}>‚Üë</span>
                        <span className="px-2 py-1 text-xs rounded bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700"
                              onClick={(e)=>{ e.preventDefault(); e.stopPropagation(); moveItem(idx, 1); }}>‚Üì</span>
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            </div>

            <div className="space-y-4">
              <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-5">
                <div className="font-bold text-red-900 dark:text-red-200 mb-2">‚ö†Ô∏è √Ä ne pas rater</div>
                <ul className="list-disc pl-5 text-sm text-red-900/90 dark:text-red-200/90 space-y-1">
                  {plan.essentials.baggage.map((x,i)=><li key={i}>{x}</li>)}
                </ul>
              </div>

              <div className="bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700 rounded-xl p-5">
                <div className="font-bold text-slate-900 dark:text-slate-100 mb-2">‚úàÔ∏è Vols</div>
                <div className="text-sm text-gray-700 dark:text-gray-200">
                  <div className="mb-2">
                    <b>Aller :</b> {plan.essentials.flights.outbound.flight} ‚Äî {plan.essentials.flights.outbound.from} (T{plan.essentials.flights.outbound.terminal})
                    <br/> {plan.essentials.flights.outbound.depart} ‚Üí {plan.essentials.flights.outbound.arrive} ({plan.essentials.flights.outbound.to})
                  </div>
                  <div className="mb-2">
                    <b>Retour :</b> {plan.essentials.flights.inbound.flight} ‚Äî {plan.essentials.flights.inbound.from}
                    <br/> {plan.essentials.flights.inbound.depart} ‚Üí {plan.essentials.flights.inbound.arrive} ({plan.essentials.flights.inbound.to})
                  </div>
                  <div className="text-xs text-gray-500">{plan.essentials.flights.note}</div>
                </div>
              </div>

              <div className="bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700 rounded-xl p-5">
                <div className="font-bold text-slate-900 dark:text-slate-100 mb-2">üí∂ Budget</div>
                <ul className="list-disc pl-5 text-sm text-gray-700 dark:text-gray-200 space-y-1">
                  {plan.essentials.money.map((x,i)=><li key={i}>{x}</li>)}
                </ul>
              </div>
            </div>
          </div>

          {editing && (
            <Modal onClose={()=>setEditing(null)}>
              <div className="p-4 border-b border-gray-200 dark:border-stone-700 flex items-center justify-between">
                <div className="font-bold text-slate-900 dark:text-slate-100">Modifier</div>
                <button className="px-2 py-1 rounded bg-gray-100 dark:bg-stone-700" onClick={()=>setEditing(null)}>‚úñ</button>
              </div>

              <div className="p-4 grid md:grid-cols-2 gap-3">
                <div className="md:col-span-2">
                  <label className="text-xs text-gray-500">Titre</label>
                  <input className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-stone-700 bg-white dark:bg-stone-900"
                         value={editing.item.title}
                         onChange={(e)=>setEditing({...editing, item:{...editing.item, title:e.target.value}})} />
                </div>

                <div>
                  <label className="text-xs text-gray-500">Type</label>
                  <select className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-stone-700 bg-white dark:bg-stone-900"
                          value={editing.item.kind}
                          onChange={(e)=>setEditing({...editing, item:{...editing.item, kind:e.target.value}})}>
                    {Object.keys(KIND).map(k => <option key={k} value={k}>{KIND[k].label}</option>)}
                  </select>
                </div>

                <div>
                  <label className="text-xs text-gray-500">Heure</label>
                  <div className="flex gap-2">
                    <input className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-stone-700 bg-white dark:bg-stone-900"
                           placeholder="d√©but"
                           value={editing.item.start || ""}
                           onChange={(e)=>setEditing({...editing, item:{...editing.item, start:e.target.value}})} />
                    <input className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-stone-700 bg-white dark:bg-stone-900"
                           placeholder="fin (optionnel)"
                           value={editing.item.end || ""}
                           onChange={(e)=>setEditing({...editing, item:{...editing.item, end:e.target.value}})} />
                  </div>
                </div>

                <div className="md:col-span-2">
                  <label className="text-xs text-gray-500">D√©tails</label>
                  <textarea className="w-full h-28 px-3 py-2 rounded-lg border border-gray-200 dark:border-stone-700 bg-white dark:bg-stone-900"
                            value={editing.item.details || ""}
                            onChange={(e)=>setEditing({...editing, item:{...editing.item, details:e.target.value}})} />
                </div>
              </div>

              <div className="p-4 border-t border-gray-200 dark:border-stone-700 flex justify-between">
                <button className="px-3 py-2 text-sm rounded-lg bg-red-600 text-white"
                        onClick={()=>{
                          updatePlan(next => {
                            const di = next.days.findIndex(d => d.date === activeDay);
                            next.days[di].items = next.days[di].items.filter(x => x.id !== editing.item.id);
                          });
                          setEditing(null);
                        }}>
                  Supprimer
                </button>

                <div className="flex gap-2">
                  <button className="px-3 py-2 text-sm rounded-lg bg-gray-100 dark:bg-stone-700"
                          onClick={()=>setEditing(null)}>
                    Annuler
                  </button>
                  <button className="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white"
                          onClick={()=>{
                            updatePlan(next => {
                              const di = next.days.findIndex(d => d.date === activeDay);
                              const idx = next.days[di].items.findIndex(x => x.id === editing.item.id);
                              if (idx >= 0) next.days[di].items[idx] = editing.item;
                            });
                            setEditing(null);
                          }}>
                    Enregistrer
                  </button>
                </div>
              </div>
            </Modal>
          )}

          {jsonEditor && (
            <Modal onClose={()=>setJsonEditor(false)}>
              <div className="p-4 border-b border-gray-200 dark:border-stone-700 flex items-center justify-between">
                <div className="font-bold text-slate-900 dark:text-slate-100">√âdition JSON (surcharge locale)</div>
                <button className="px-2 py-1 rounded bg-gray-100 dark:bg-stone-700" onClick={()=>setJsonEditor(false)}>‚úñ</button>
              </div>
              <div className="p-4">
                <div className="text-xs text-gray-500 mb-2">
                  Pour partager : Exporter ‚Üí remplacer <code>data/tripPlan.json</code> ‚Üí commit/push.
                </div>
                <textarea className="w-full h-80 font-mono text-xs p-3 rounded-lg border border-gray-200 dark:border-stone-700 bg-white dark:bg-stone-900"
                          value={draft}
                          onChange={(e)=>setDraft(e.target.value)}></textarea>
              </div>
              <div className="p-4 border-t border-gray-200 dark:border-stone-700 flex justify-end gap-2">
                <button className="px-3 py-2 text-sm rounded-lg bg-gray-100 dark:bg-stone-700" onClick={()=>setJsonEditor(false)}>Annuler</button>
                <button className="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white" onClick={applyDraft}>Appliquer</button>
              </div>
            </Modal>
          )}
        </div>
      );
    };

    // --- App ---
    const App = () => {
      const [activeTab, setActiveTab] = useLocalStorageState("athens_tab_v2", "zones");
      const [darkMode, setDarkMode] = useLocalStorageState("athens_dark_v2", false);
      const [query, setQuery] = useState("");
      const [thumbs, setThumbs] = useState({}); // {placeId: {thumb,page}}

      useEffect(() => {
        if (darkMode) document.documentElement.classList.add("dark");
        else document.documentElement.classList.remove("dark");
      }, [darkMode]);

      const getMapsLink = (place) => {
        const q = encodeURIComponent(`${place.address} ${place.name} Athens`);
        return `https://www.google.com/maps/search/?api=1&query=${q}`;
      };

      // Load wiki thumbs once (simple concurrency: sequential)
      useEffect(() => {
        let cancelled = false;
        (async () => {
          for (const p of placesData) {
            if (!p.wikiTitle) continue;
            if (thumbs[p.id]) continue;
            try {
              const info = await fetchWikiThumb(p.wikiTitle);
              if (cancelled) return;
              setThumbs(prev => ({ ...prev, [p.id]: info }));
            } catch {
              // ignore
            }
          }
        })();
        return () => { cancelled = true; };
      }, []);

      const filteredPlaces = useMemo(() => {
        const q = query.trim().toLowerCase();
        return placesData.filter(p => !q || (p.name + " " + p.zone + " " + p.address).toLowerCase().includes(q));
      }, [query]);

      const grouped = useMemo(() => {
        const acc = {};
        for (const p of filteredPlaces) (acc[p.zone] = acc[p.zone] || []).push(p);
        return acc;
      }, [filteredPlaces]);

      return (
        <div className="max-w-6xl mx-auto p-4 md:p-8 min-h-screen">

          <div className="flex items-center justify-between gap-3 mb-4">
            <div className="text-xs text-gray-500 dark:text-gray-400">GitHub Pages ‚Ä¢ Photos via Wikipedia ‚Ä¢ Planning agenda</div>
            <button
              onClick={() => setDarkMode(!darkMode)}
              className="p-2 rounded-full bg-gray-200 dark:bg-stone-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-stone-600 transition-colors text-sm font-bold"
            >
              {darkMode ? "‚òÄÔ∏è Mode Jour" : "üåô Mode Nuit"}
            </button>
          </div>

          <header className="mb-8">
            <div className="bg-white dark:bg-stone-800 border border-gray-200 dark:border-stone-700 rounded-2xl p-6 md:p-8">
              <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                <div>
                  <h1 className="text-4xl md:text-6xl text-slate-900 dark:text-slate-100 tracking-tight">Ath√®nes</h1>
                  <h2 className="text-lg md:text-2xl text-slate-600 dark:text-slate-300 italic font-light font-serif">Guide pratique + planning</h2>
                  <div className="mt-3 inline-flex items-center gap-2 px-4 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full text-sm border border-blue-100 dark:border-blue-800">
                    <span>‚õÖ Janvier :</span><span className="font-bold">10¬∞C - 15¬∞C</span>
                  </div>
                </div>

                <div className="w-full md:w-[360px]">
                  <div className="text-xs text-gray-500 mb-1">Recherche lieux</div>
                  <input
                    value={query}
                    onChange={(e)=>setQuery(e.target.value)}
                    placeholder="Acropole, Agora, mus√©e..."
                    className="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-stone-700 bg-white dark:bg-stone-900"
                  />
                </div>
              </div>
            </div>
          </header>

          <nav className="flex flex-wrap justify-center gap-2 md:gap-6 mb-8 border-b border-gray-200 dark:border-stone-700 sticky top-0 bg-[#f4f1ea] dark:bg-stone-900 z-20 py-2">
            {[
              { id: "zones", label: "üèõÔ∏è Lieux" },
              { id: "planning", label: "üóìÔ∏è Planning" },
              { id: "map", label: "üó∫Ô∏è Carte" },
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={"px-4 py-2 rounded-full text-sm md:text-base transition-all " + (activeTab===tab.id
                  ? "bg-[#8c2f39] text-white shadow-lg"
                  : "text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-stone-800")}
              >
                {tab.label}
              </button>
            ))}
          </nav>

          {activeTab === "zones" && (
            <div className="animate-fade-in space-y-10">
              {zoneOrder.map(zone => {
                const places = grouped[zone] || [];
                if (!places.length) return null;
                const c = colorToTailwind[places[0].color] || "blue";

                const primaries = places.filter(p => p.type === "Primaire");
                const secondaries = places.filter(p => p.type === "Secondaire");

                return (
                  <section key={zone}>
                    <h3 className={"text-2xl font-bold serif-title mb-5 pb-2 border-b-2 border-" + c + "-600 text-" + c + "-900 dark:text-" + c + "-300"}>
                      {zoneTitle(zone)}
                    </h3>

                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {primaries.map(p => (
                        <PlaceCard key={p.id} p={p} c={c} getMapsLink={getMapsLink} wikiThumb={thumbs[p.id]} />
                      ))}
                      {secondaries.map(p => (
                        <PlaceCard key={p.id} p={p} c={c} getMapsLink={getMapsLink} wikiThumb={thumbs[p.id]} />
                      ))}
                    </div>
                  </section>
                );
              })}
            </div>
          )}

          {activeTab === "planning" && (
            <PlanningTab />
          )}

          {activeTab === "map" && (
            <div className="animate-fade-in bg-white dark:bg-stone-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-stone-700">
              <MapComponent places={placesData} darkMode={darkMode} />
              <p className="text-center text-gray-500 text-sm mt-4">Carte : sites majeurs et secondaires.</p>
            </div>
          )}

          <footer className="mt-16 text-center text-gray-400 text-sm pb-8 border-t border-gray-200 dark:border-stone-700 pt-8">
            Ath√®nes ‚Ä¢ Photos via Wikipedia ‚Ä¢ Planning agenda
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
